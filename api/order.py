from http.server import BaseHTTPRequestHandler
import json
import os
import requests

class Handler(BaseHTTPRequestHandler):
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def do_POST(self):
        try:
            content_length = int(self.headers['Content-Length'])
            post_data = self.rfile.read(content_length)
            order_data = json.loads(post_data)
            
            success = self.send_admin_notification(order_data)
            
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.send_header('Access-Control-Allow-Origin', '*')
            self.end_headers()
            
            if success:
                response = {'success': True, 'message': 'Order processed successfully'}
            else:
                response = {'success': False, 'message': 'Failed to send notification'}
                
            self.wfile.write(json.dumps(response).encode('utf-8'))
            
        except Exception as e:
            self.send_response(500)
            self.send_header('Content-type', 'application/json')
            self.send_header('Access-Control-Allow-Origin', '*')
            self.end_headers()
            response = {'success': False, 'error': str(e)}
            self.wfile.write(json.dumps(response).encode('utf-8'))
    
    def send_admin_notification(self, order_data):
        try:
            bot_token = os.environ.get('BOT_TOKEN')
            admin_chat_id = os.environ.get('ADMIN_CHAT_ID')
            
            if not bot_token or not admin_chat_id:
                return False
            
            clean_phone = order_data['phone'].replace(' ', '').replace('(', '').replace(')', '').replace('-', '')
            telegram_url = f"https://t.me/{clean_phone}"
            
            items_text = "\n".join([
                f"‚Ä¢ {item['name']} - {item['quantity']} —à—Ç. √ó {item['price']} ‚ÇΩ = {item['total']} ‚ÇΩ" 
                for item in order_data['items']
            ])
            
            message = f"""üéâ <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó!</b>

üë§ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ:</b>
üÜî ID: <code>{order_data['user']['id']}</code>
üìõ –ò–º—è: {order_data['user']['first_name']}
üë§ –Æ–∑–µ—Ä–Ω–µ–π–º: @{order_data['user']['username']}
üìû –¢–µ–ª–µ—Ñ–æ–Ω: <code>{clean_phone}</code>

üõçÔ∏è <b>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</b>
{items_text}

üíµ <b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> {order_data['total']} ‚ÇΩ

üìã <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> {order_data['comment'] or '–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}

üïê <b>–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞:</b> {order_data['time']}

üí¨ <a href="{telegram_url}">–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—é</a>"""
            
            url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
            payload = {
                'chat_id': admin_chat_id,
                'text': message,
                'parse_mode': 'HTML',
                'disable_web_page_preview': False
            }
            
            response = requests.post(url, json=payload, timeout=10)
            return response.status_code == 200
            
        except Exception as e:
            return False
